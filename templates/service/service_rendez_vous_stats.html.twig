{% extends 'base_admin.html.twig' %}

{% block title %}Service & Appointment Statistics{% endblock %}

{% block body %}
    <h1 class="text-center text-primary mb-4">Service & Appointment Statistics</h1>

    <div class="container mt-3">
        <div class="row row-cols-1 row-cols-md-2 g-4">
            <!-- Card for Services Overview -->
            <div class="col">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Services Overview</h5>
                        <canvas id="serviceTypesChart" class="mb-3" style="max-height: 300px;"></canvas>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Price (TND)</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for service in services %}
                                    <tr>
                                        <td>{{ service.id }}</td>
                                        <td>{{ service.nom }}</td>
                                        <td>{{ service.type }}</td>
                                        <td>{{ service.prix }} TND</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card for Service Statistics -->
            <div class="col">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Service Type Distribution</h5>
                        <canvas id="serviceDistributionChart" class="mb-3" style="max-height: 300px;"></canvas>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Total Price</th>
                                    <th>Count</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for typeData in serviceStats %}
                                    <tr>
                                        <td>{{ typeData.type }}</td>
                                        <td>{{ typeData.totalPrice }} TND</td>
                                        <td>{{ typeData.count }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card for Appointments Overview -->
            <div class="col">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Appointments Overview</h5>
                        <canvas id="appointmentStatusChart" class="mb-3" style="max-height: 300px;"></canvas>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Service</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for appointment in appointments %}
                                    <tr>
                                        <td>{{ appointment.id }}</td>
                                        <td>{{ appointment.date|date('Y-m-d H:i:s') }}</td>
                                        <td>{{ appointment.statut ? 'Confirmed' : 'Not Confirmed' }}</td>
                                        <td>{{ appointment.service.nom }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card for Appointment Statistics -->
            <div class="col">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Appointments by Service</h5>
                        <canvas id="appointmentsByServiceChart" class="mb-3" style="max-height: 300px;"></canvas>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead>
                                <tr>
                                    <th>Service Name</th>
                                    <th>Number of Appointments</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for serviceData in appointmentStats %}
                                    <tr>
                                        <td>{{ serviceData.serviceName }}</td>
                                        <td>{{ serviceData.count }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Count Confirmed and Not Confirmed appointments in Twig
            {% set confirmedCount = 0 %}
            {% set notConfirmedCount = 0 %}
            {% for appointment in appointments %}
            {% if appointment.statut %}
            {% set confirmedCount = confirmedCount + 1 %}
            {% else %}
            {% set notConfirmedCount = notConfirmedCount + 1 %}
            {% endif %}
            {% endfor %}

            // Data for Service Types (Pie Chart)
            let serviceTypesCtx = document.getElementById('serviceTypesChart').getContext('2d');
            new Chart(serviceTypesCtx, {
                type: 'pie',
                data: {
                    labels: [{% for service in services %}"{{ service.type }}"{% if not loop.last %},{% endif %}{% endfor %}],
                    datasets: [{
                        data: [{% for service in services %}1{% if not loop.last %},{% endif %}{% endfor %}],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(153, 102, 255, 0.6)',
                            // Add more colors if needed
                        ]
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        title: {
                            display: true,
                            text: 'Distribution of Service Types'
                        }
                    }
                }
            });

            // Data for Service Distribution (Bar Chart)
            let serviceDistributionCtx = document.getElementById('serviceDistributionChart').getContext('2d');
            new Chart(serviceDistributionCtx, {
                type: 'bar',
                data: {
                    labels: [{% for stat in serviceStats %}"{{ stat.type }}"{% if not loop.last %},{% endif %}{% endfor %}],
                    datasets: [{
                        label: 'Total Price (TND)',
                        data: [{% for stat in serviceStats %}{{ stat.totalPrice }}{% if not loop.last %},{% endif %}{% endfor %}],
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Count',
                        data: [{% for stat in serviceStats %}{{ stat.count }}{% if not loop.last %},{% endif %}{% endfor %}],
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Value/Count'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        title: {
                            display: true,
                            text: 'Service Type Statistics'
                        }
                    }
                }
            });

            // Data for Appointment Status (Pie Chart)
            let appointmentStatusCtx = document.getElementById('appointmentStatusChart').getContext('2d');
            new Chart(appointmentStatusCtx, {
                type: 'pie',
                data: {
                    labels: ['Confirmed', 'Not Confirmed'],
                    datasets: [{
                        data: [{{ confirmedCount }}, {{ notConfirmedCount }}],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(255, 99, 132, 0.6)'
                        ]
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        title: {
                            display: true,
                            text: 'Distribution of Appointment Statuses'
                        }
                    }
                }
            });

            // Data for Appointments by Service (Bar Chart)
            let appointmentsByServiceCtx = document.getElementById('appointmentsByServiceChart').getContext('2d');
            new Chart(appointmentsByServiceCtx, {
                type: 'bar',
                data: {
                    labels: [{% for stat in appointmentStats %}"{{ stat.serviceName }}"{% if not loop.last %},{% endif %}{% endfor %}],
                    datasets: [{
                        label: 'Number of Appointments',
                        data: [{% for stat in appointmentStats %}{{ stat.count }}{% if not loop.last %},{% endif %}{% endfor %}],
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Appointments'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // Hide legend since we only have one dataset
                        },
                        title: {
                            display: true,
                            text: 'Appointments by Service'
                        }
                    }
                }
            });
        });
    </script>
{% endblock %}