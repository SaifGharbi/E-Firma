{% extends 'base.html.twig' %}

{% block title %}Our Products{% endblock %}

{% block body %}
    <section class="ftco-section">
        <div class="container">
            <div class="row justify-content-center mb-3 pb-3">
                <div class="col-md-12 heading-section text-center ftco-animate">
                    <h2 class="mb-4">Our Products</h2>
                    <p>Browse our wide selection of fresh and organic products</p>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="row mb-4">
                <div class="col-md-6 mx-auto">
                    <input type="text" id="search-input" class="form-control" placeholder="Search for products...">
                </div>
            </div>

            <div class="row g-4" id="products-container"> <!-- Added spacing between cards -->
                {% for produit in produits %}
                    <div class="col-md-6 col-lg-3 ftco-animate product-card-wrapper">
                        <div class="card shadow-sm border-0 rounded m-3 position-relative product-card"> <!-- Added margin around cards -->
                            {% if produit.image %}
                                <img src="{{ asset('/uploads/images/' ~ produit.image) }}" alt="{{ produit.nom }}" class="card-img-top" style="height: 200px; object-fit: cover;">
                            {% else %}
                                <div class="text-center py-3 text-muted">Pas d'image</div>
                            {% endif %}
                            <div class="card-body text-center">
                                <h5 class="card-title text-success">{{ produit.nom }}</h5>
                                <p class="card-text text-muted">{{ produit.description }}</p>
                                <p class="text-primary fw-bold">{{ produit.prix }} TND</p>

                                <div class="bottom-area d-flex justify-content-center px-3">
                                    <a href="#" class="add-to-cart d-flex justify-content-center align-items-center text-center"
                                       onclick="addToCart({{ produit.id }})">
                                        <span><i class="ion-ios-cart"></i></span> Add to Cart
                                    </a>

                                </div>
                                <!-- Heart Button -->
                                <div class="bottom-area d-flex justify-content-center px-3 mt-2">
                                    <i class="fas fa-heart heart-icon position-absolute top-0 end-0 m-2"
                                       data-product-id="{{ produit.id }}"
                                       onclick="toggleLike({{ produit.id }})"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </section>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const likedProducts = JSON.parse(localStorage.getItem('likedProducts')) || [];
            likedProducts.forEach(id => {
                const heartIcon = document.querySelector(`.heart-icon[data-product-id='${id}']`);
                if (heartIcon) {
                    heartIcon.classList.add('liked');
                }
            });

            // Live search with AJAX
            document.getElementById("search-input").addEventListener("keyup", function () {
                let query = this.value.toLowerCase();
                let products = document.querySelectorAll(".product-card-wrapper");

                products.forEach(product => {
                    let productName = product.querySelector(".card-title").textContent.toLowerCase();
                    if (productName.includes(query)) {
                        product.style.display = "block";
                    } else {
                        product.style.display = "none";
                    }
                });
            });
        });

        function toggleLike(productId) {
            const heartIcon = document.querySelector(`.heart-icon[data-product-id='${productId}']`);
            if (!heartIcon) return;

            heartIcon.classList.toggle("liked");
            let likedProducts = JSON.parse(localStorage.getItem('likedProducts')) || [];

            if (heartIcon.classList.contains("liked")) {
                likedProducts.push(productId);
            } else {
                likedProducts = likedProducts.filter(id => id !== productId);
            }
            localStorage.setItem('likedProducts', JSON.stringify(likedProducts));
        }
        document.addEventListener("DOMContentLoaded", function () {
            const likedProducts = JSON.parse(localStorage.getItem('likedProducts')) || [];
            likedProducts.forEach(id => {
                const heartIcon = document.querySelector(`.heart-icon[data-product-id='${id}']`);
                if (heartIcon) {
                    heartIcon.classList.add('liked');
                }
            });
        });

        function toggleLike(productId) {
            const heartIcon = document.querySelector(`.heart-icon[data-product-id='${productId}']`);
            if (!heartIcon) return;

            heartIcon.classList.toggle("liked");
            let likedProducts = JSON.parse(localStorage.getItem('likedProducts')) || [];

            if (heartIcon.classList.contains("liked")) {
                likedProducts.push(productId);
            } else {
                likedProducts = likedProducts.filter(id => id !== productId);
            }

            localStorage.setItem('likedProducts', JSON.stringify(likedProducts));
        }
    </script>

    <style>
        .heart-icon {
            font-size: 22px;
            color: #ccc;
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease-in-out;
            position: absolute;
            top: 10px; /* Move it down from the top */
            right: 10px; /* Move it left from the right */
            z-index: 10; /* Ensure it stays above other elements */
        }

        .heart-icon.liked {
            color: red;
            transform: scale(1.2);
        }


        .product-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .product-card:hover {
            transform: scale(1.05);
            box-shadow: 0px 10px 20px rgba(0, 0, 0, 0.15);
        }
        .heart-icon {
            font-size: 22px;
            color: #ccc;
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease-in-out;
        }



        .product-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .product-card:hover {
            transform: scale(1.05);
            box-shadow: 0px 10px 20px rgba(0, 0, 0, 0.15);
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        function addToCart(productId) {
            fetch('/cart/add/' + productId, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    updateCartCount();
                })
                .catch(error => console.error('Error:', error));
        }

        function updateCartCount() {
            fetch('/cart/view')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('cart-count').innerText = Object.keys(data).length;
                })
                .catch(error => console.error('Error:', error));
        }

        document.addEventListener("DOMContentLoaded", updateCartCount);
    </script>

{% endblock %}
